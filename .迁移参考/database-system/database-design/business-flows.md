# 业务流程图

## 1. 文件上传和分析流程

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│                 │     │                 │     │                 │
│  上传文件       │────>│  创建ChatFile   │────>│  基础分析       │
│                 │     │  记录           │     │                 │
└─────────────────┘     └─────────────────┘     └────────┬────────┘
                                                         │
                                                         ▼
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│                 │     │                 │     │                 │
│ 查看基础分析    │<────│ 更新状态为      │<────│ 计算字数        │
│ 结果            │     │ completed_basic │     │                 │
└────────┬────────┘     └─────────────────┘     └─────────────────┘
         │
         │                                      ┌─────────────────┐
         │                                      │                 │
         └─────────────────────────────────────>│ 请求AI分析      │
                                                │                 │
                                                └────────┬────────┘
                                                         │
                                                         ▼
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│                 │     │                 │     │                 │
│ 检查用户是否    │────>│ 检查积分是否    │────>│ 创建积分消费    │
│ 登录            │     │ 足够            │     │ 记录            │
└─────────────────┘     └─────────────────┘     └────────┬────────┘
                                                         │
                                                         ▼
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│                 │     │                 │     │                 │
│ 查看AI分析      │<────│ 更新状态为      │<────│ 执行AI分析      │
│ 结果            │     │ complete_ai     │     │                 │
└─────────────────┘     └─────────────────┘     └─────────────────┘
```

## 2. 用户注册和登录流程

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│                 │     │                 │     │                 │
│  访问网站       │────>│  选择登录方式   │────>│ 社交账号授权    │
│                 │     │                 │     │                 │
└─────────────────┘     └─────────────────┘     └────────┬────────┘
                                                         │
                                                         ▼
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│                 │     │                 │     │                 │
│ 关联历史文件    │<────│ 创建/更新用户   │<────│ 获取用户信息    │
│                 │     │                 │     │                 │
└─────────────────┘     └─────────────────┘     └─────────────────┘
```

## 3. 积分充值流程

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│                 │     │                 │     │                 │
│  选择充值套餐   │────>│  创建订单记录   │────>│  跳转支付页面   │
│                 │     │                 │     │                 │
└─────────────────┘     └─────────────────┘     └────────┬────────┘
                                                         │
                                                         ▼
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│                 │     │                 │     │                 │
│ 创建积分充值    │<────│ 更新订单状态    │<────│ 用户完成支付    │
│ 记录            │     │ 为paid          │     │                 │
└────────┬────────┘     └─────────────────┘     └─────────────────┘
         │
         ▼
┌─────────────────┐
│                 │
│ 更新用户积分    │
│ 余额            │
└─────────────────┘
```

## 4. 未登录用户关联流程

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│                 │     │                 │     │                 │
│ 未登录用户      │────>│ 上传文件        │────>│ 生成会话ID      │
│ 访问网站        │     │                 │     │                 │
└─────────────────┘     └─────────────────┘     └────────┬────────┘
                                                         │
                                                         ▼
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│                 │     │                 │     │                 │
│ 创建ChatFile    │────>│ 基础分析        │────>│ 用户登录        │
│ (session_id)    │     │                 │     │                 │
└─────────────────┘     └─────────────────┘     └────────┬────────┘
                                                         │
                                                         ▼
┌─────────────────┐     ┌─────────────────┐
│                 │     │                 │
│ 查找相同        │────>│ 更新ChatFile    │
│ session_id文件  │     │ user_uuid       │
└─────────────────┘     └─────────────────┘
```

## 5. 系统整体流程

```
                    ┌───────────────────────────────────────┐
                    │                                       │
                    │               用户访问                │
                    │                                       │
                    └───────────────┬───────────────────────┘
                                    │
                    ┌───────────────▼───────────────────────┐
                    │                                       │
          ┌─────────┤          是否已登录?                 ├─────────┐
          │         │                                       │         │
          │         └───────────────────────────────────────┘         │
          │                                                           │
┌─────────▼───────────────┐                           ┌───────────────▼─────────┐
│                         │                           │                         │
│      未登录用户         │                           │       已登录用户        │
│                         │                           │                         │
└─────────┬───────────────┘                           └───────────┬─────────────┘
          │                                                       │
┌─────────▼───────────────┐                           ┌───────────▼─────────────┐
│                         │                           │                         │
│   上传文件 + 基础分析   │                           │  上传文件 + 基础分析    │
│                         │                           │                         │
└─────────┬───────────────┘                           └───────────┬─────────────┘
          │                                                       │
          │                                           ┌───────────▼─────────────┐
          │                                           │                         │
          │                                           │       AI分析            │
          │                                           │                         │
          │                                           └───────────┬─────────────┘
          │                                                       │
          │                                           ┌───────────▼─────────────┐
          │                                           │                         │
          │                                           │     积分消费记录        │
          │                                           │                         │
          │                                           └───────────┬─────────────┘
          │                                                       │
┌─────────▼───────────────┐                           ┌───────────▼─────────────┐
│                         │                           │                         │
│       登录/注册         │                           │       充值积分          │
│                         │                           │                         │
└─────────┬───────────────┘                           └───────────┬─────────────┘
          │                                                       │
┌─────────▼───────────────┐                           ┌───────────▼─────────────┐
│                         │                           │                         │
│     关联历史文件        │                           │     查看历史记录        │
│                         │                           │                         │
└─────────────────────────┘                           └─────────────────────────┘
```

## 关键业务规则

1. **未登录用户限制**:
   - 可以上传文件并获取基础分析
   - 不能进行AI分析
   - 不能充值积分
   - 不能查看历史记录

2. **积分计算规则**:
   - 基础分析：免费
   - AI分析：根据文件字数计算所需积分
     - 例如：每1000字消耗100积分

3. **文件状态流转**:
   - uploaded → processing → completed_basic
   - completed_basic → processing → complete_ai (如果请求AI分析)
   - 任何阶段都可能变为failed (如果处理失败)

4. **订单状态流转**:
   - pending → paid (支付成功)
   - pending → cancelled (支付失败或用户取消)
